name: Update README with Docker Images

on:
  push:
    branches:
      - main
    paths:
      - '**/Dockerfile'
      - '!.github/**'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  update-readme:
    name: Update README
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Scan and update README
        id: update
        run: |
          echo "üîç Scanning repository for Docker images..."

          # Function to get versions from a directory
          get_versions() {
            local dir="$1"
            if [ -d "$dir" ]; then
              find "$dir" -maxdepth 1 -mindepth 1 -type d -printf '%f\n' 2>/dev/null | grep -E '^[0-9]' | sort -V || true
            fi
          }

          # Function to get subdirectories
          get_subdirs() {
            local dir="$1"
            if [ -d "$dir" ]; then
              find "$dir" -maxdepth 1 -mindepth 1 -type d -printf '%f\n' 2>/dev/null | sort || true
            fi
          }

          # Function to check if image is in README
          check_image() {
            local pattern="$1"
            grep -q "$pattern" README.md
          }

          # Function to add image row to README after a marker
          add_image_row() {
            local marker="$1"
            local new_row="$2"
            local temp_file=$(mktemp)

            awk -v marker="$marker" -v new_row="$new_row" '
              {
                print
                if (index($0, marker) > 0 && !added) {
                  print new_row
                  added = 1
                }
              }
            ' README.md > "$temp_file" && mv "$temp_file" README.md
          }

          CHANGES_MADE=""

          # ============================================
          # Check Java Base versions
          # ============================================
          echo "üì¶ Checking Java Base..."
          for v in $(get_versions "java/base"); do
            if ! check_image "java:$v"; then
              echo "  ‚ûï Adding java:$v"
              # Find last java entry and add after it
              last_java=$(grep -n "| java:[0-9]" README.md | tail -1 | cut -d: -f1)
              if [ -n "$last_java" ]; then
                sed -i "${last_java}a\\| java:$v | \`ghcr.io/goover/java:$v\` | ‚úÖ | ‚úÖ |" README.md
                CHANGES_MADE="${CHANGES_MADE}Java Base: $v\n"
              fi
            fi
          done

          # ============================================
          # Check Java GraalVM versions
          # ============================================
          echo "üì¶ Checking Java GraalVM..."
          for v in $(get_versions "java/graalvm"); do
            if ! check_image "java:graalvm_$v"; then
              echo "  ‚ûï Adding java:graalvm_$v"
              last_graalvm=$(grep -n "| java:graalvm_" README.md | tail -1 | cut -d: -f1)
              if [ -n "$last_graalvm" ]; then
                sed -i "${last_graalvm}a\\| java:graalvm_$v | \`ghcr.io/goover/java:graalvm_$v\` | ‚úÖ | ‚úÖ |" README.md
                CHANGES_MADE="${CHANGES_MADE}Java GraalVM: $v\n"
              fi
            fi
          done

          # ============================================
          # Check Java Corretto versions
          # ============================================
          echo "üì¶ Checking Java Corretto..."
          for v in $(get_versions "java/corretto"); do
            if ! check_image "java:corretto_$v"; then
              echo "  ‚ûï Adding java:corretto_$v"
              last_corretto=$(grep -n "| java:corretto_" README.md | tail -1 | cut -d: -f1)
              if [ -n "$last_corretto" ]; then
                sed -i "${last_corretto}a\\| java:corretto_$v | \`ghcr.io/goover/java:corretto_$v\` | ‚úÖ | ‚úÖ |" README.md
                CHANGES_MADE="${CHANGES_MADE}Java Corretto: $v\n"
              fi
            fi
          done

          # ============================================
          # Check Java Zulu versions
          # ============================================
          echo "üì¶ Checking Java Zulu..."
          for v in $(get_versions "java/zulu"); do
            if ! check_image "java:zulu_$v"; then
              echo "  ‚ûï Adding java:zulu_$v"
              last_zulu=$(grep -n "| java:zulu_" README.md | tail -1 | cut -d: -f1)
              if [ -n "$last_zulu" ]; then
                sed -i "${last_zulu}a\\| java:zulu_$v | \`ghcr.io/goover/java:zulu_$v\` | ‚úÖ | ‚úÖ |" README.md
                CHANGES_MADE="${CHANGES_MADE}Java Zulu: $v\n"
              fi
            fi
          done

          # ============================================
          # Check Java Dragonwell versions
          # ============================================
          echo "üì¶ Checking Java Dragonwell..."
          for v in $(get_versions "java/dragonwell"); do
            if ! check_image "java:dragonwell_$v"; then
              echo "  ‚ûï Adding java:dragonwell_$v"
              last_dragonwell=$(grep -n "| java:dragonwell_" README.md | tail -1 | cut -d: -f1)
              if [ -n "$last_dragonwell" ]; then
                sed -i "${last_dragonwell}a\\| java:dragonwell_$v | \`ghcr.io/goover/java:dragonwell_$v\` | ‚úÖ | ‚úÖ |" README.md
                CHANGES_MADE="${CHANGES_MADE}Java Dragonwell: $v\n"
              fi
            fi
          done

          # ============================================
          # Check Java Liberica versions
          # ============================================
          echo "üì¶ Checking Java Liberica..."
          for v in $(get_versions "java/liberica"); do
            if ! check_image "java:liberica_$v"; then
              echo "  ‚ûï Adding java:liberica_$v"
              last_liberica=$(grep -n "| java:liberica_" README.md | tail -1 | cut -d: -f1)
              if [ -n "$last_liberica" ]; then
                sed -i "${last_liberica}a\\| java:liberica_$v | \`ghcr.io/goover/java:liberica_$v\` | ‚úÖ | ‚úÖ |" README.md
                CHANGES_MADE="${CHANGES_MADE}Java Liberica: $v\n"
              fi
            fi
          done

          # ============================================
          # Check Java Shenandoah versions
          # ============================================
          echo "üì¶ Checking Java Shenandoah..."
          for v in $(get_versions "java/shenandoah"); do
            if ! check_image "java:shenandoah_$v"; then
              echo "  ‚ûï Adding java:shenandoah_$v"
              last_shenandoah=$(grep -n "| java:shenandoah_" README.md | tail -1 | cut -d: -f1)
              if [ -n "$last_shenandoah" ]; then
                sed -i "${last_shenandoah}a\\| java:shenandoah_$v | \`ghcr.io/goover/java:shenandoah_$v\` | ‚úÖ | ‚úÖ |" README.md
                CHANGES_MADE="${CHANGES_MADE}Java Shenandoah: $v\n"
              fi
            fi
          done

          # ============================================
          # Check Database versions
          # ============================================
          for db in mariadb postgres mongodb redis; do
            echo "üì¶ Checking $db..."
            for v in $(get_versions "database/$db"); do
              if ! check_image "$db:$v"; then
                echo "  ‚ûï Adding $db:$v"
                last_db=$(grep -n "| $db:" README.md | tail -1 | cut -d: -f1)
                if [ -n "$last_db" ]; then
                  sed -i "${last_db}a\\| $db:$v | \`ghcr.io/goover/$db:$v\` | ‚úÖ | ‚úÖ |" README.md
                  CHANGES_MADE="${CHANGES_MADE}${db^}: $v\n"
                fi
              fi
            done
          done

          # ============================================
          # Check Dev images (nodejs, python, go, etc.)
          # ============================================
          for dev in nodejs python go elixir; do
            echo "üì¶ Checking $dev..."
            for v in $(get_versions "dev/$dev"); do
              if ! check_image "$dev:$v"; then
                echo "  ‚ûï Adding $dev:$v"
                last_dev=$(grep -n "| $dev:" README.md | tail -1 | cut -d: -f1)
                if [ -n "$last_dev" ]; then
                  sed -i "${last_dev}a\\| $dev:$v | \`ghcr.io/goover/$dev:$v\` | ‚úÖ | ‚úÖ |" README.md
                  CHANGES_MADE="${CHANGES_MADE}${dev^}: $v\n"
                fi
              fi
            done
          done

          # ============================================
          # Check DotNet versions
          # ============================================
          echo "üì¶ Checking dotnet..."
          for v in $(get_versions "dev/dotnet"); do
            if ! check_image "dotnet:$v"; then
              echo "  ‚ûï Adding dotnet:$v"
              last_dotnet=$(grep -n "| dotnet:" README.md | tail -1 | cut -d: -f1)
              if [ -n "$last_dotnet" ]; then
                sed -i "${last_dotnet}a\\| dotnet:$v | \`ghcr.io/goover/dotnet:$v\` | ‚úÖ | ‚ùå |" README.md
                CHANGES_MADE="${CHANGES_MADE}DotNet: $v\n"
              fi
            fi
          done

          # ============================================
          # Check Game images
          # ============================================
          echo "üì¶ Checking games..."
          for game in $(get_subdirs "games"); do
            if ! check_image "games:$game"; then
              echo "  ‚ûï Adding games:$game"
              last_game=$(grep -n "| games:" README.md | tail -1 | cut -d: -f1)
              if [ -n "$last_game" ]; then
                sed -i "${last_game}a\\| games:$game | \`ghcr.io/goover/games:$game\` | ‚úÖ | ‚ùå | ${game^} Server |" README.md
                CHANGES_MADE="${CHANGES_MADE}Games: $game\n"
              fi
            fi
          done

          # Output result
          if [ -n "$CHANGES_MADE" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo ""
            echo "‚úÖ Changes made:"
            echo -e "$CHANGES_MADE"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "‚úÖ README is already up to date!"
          fi

      - name: Create Pull Request
        if: steps.update.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "docs: add new Docker images to README"
          title: "üìù Update README - New Docker Images Detected"
          body: |
            ## ü§ñ Automated README Update

            This PR adds newly detected Docker images to the README.

            ### What changed:
            - New image entries have been added to the appropriate tables in README.md
            - All new entries follow the existing format

            ---

            *This PR was created automatically by the [Update README](.github/workflows/update-readme.yml) workflow.*
          branch: docs/readme-images-${{ github.run_number }}
          delete-branch: true
          add-paths: |
            README.md
          labels: |
            documentation
            automated
          assignees: gOOvER
          reviewers: gOOvER
