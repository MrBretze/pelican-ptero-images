name: Update README with Docker Images

on:
  push:
    branches:
      - main
    paths:
      - '**/Dockerfile'
      - '!.github/**'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  update-readme:
    name: Update README
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Scan and update README
        id: update
        run: |
          echo "üîç Scanning repository for Docker images..."

          # Function to get versions from a directory
          get_versions() {
            local dir="$1"
            if [ -d "$dir" ]; then
              find "$dir" -maxdepth 1 -mindepth 1 -type d -printf '%f\n' 2>/dev/null | grep -E '^[0-9]' | sort -V || true
            fi
          }

          # Function to get subdirectories
          get_subdirs() {
            local dir="$1"
            if [ -d "$dir" ]; then
              find "$dir" -maxdepth 1 -mindepth 1 -type d -printf '%f\n' 2>/dev/null | sort || true
            fi
          }

          # Function to check if image is in README
          check_image() {
            local pattern="$1"
            grep -q "$pattern" README.md
          }

          # Function to check if directory exists
          dir_exists() {
            [ -d "$1" ]
          }

          CHANGES_MADE=""

          # ============================================
          # REMOVE DELETED IMAGES
          # ============================================
          echo "üóëÔ∏è Checking for deleted images..."

          # Remove deleted DotNet versions
          for v in $(grep -oP 'dotnet:\K[0-9.]+(?= \|)' README.md | sort -u); do
            if ! dir_exists "dev/dotnet/$v"; then
              echo "  ‚ûñ Removing dotnet:$v (no longer exists)"
              sed -i "/| dotnet:$v /d" README.md
              CHANGES_MADE="${CHANGES_MADE}Removed DotNet: $v\n"
            fi
          done

          # Remove deleted Java Base versions
          for v in $(grep -oP '\| java:\K[0-9]+(?= \|)' README.md | sort -u); do
            if ! dir_exists "java/base/$v"; then
              echo "  ‚ûñ Removing java:$v (no longer exists)"
              sed -i "/| java:$v /d" README.md
              CHANGES_MADE="${CHANGES_MADE}Removed Java Base: $v\n"
            fi
          done

          # Remove deleted Java GraalVM versions
          for v in $(grep -oP 'java:graalvm_\K[0-9]+' README.md | sort -u); do
            if ! dir_exists "java/graalvm/$v"; then
              echo "  ‚ûñ Removing java:graalvm_$v (no longer exists)"
              sed -i "/| java:graalvm_$v /d" README.md
              CHANGES_MADE="${CHANGES_MADE}Removed Java GraalVM: $v\n"
            fi
          done

          # Remove deleted Java Corretto versions
          for v in $(grep -oP 'java:corretto_\K[0-9]+' README.md | sort -u); do
            if ! dir_exists "java/corretto/$v"; then
              echo "  ‚ûñ Removing java:corretto_$v (no longer exists)"
              sed -i "/| java:corretto_$v /d" README.md
              CHANGES_MADE="${CHANGES_MADE}Removed Java Corretto: $v\n"
            fi
          done

          # Remove deleted Java Zulu versions
          for v in $(grep -oP 'java:zulu_\K[0-9]+' README.md | sort -u); do
            if ! dir_exists "java/zulu/$v"; then
              echo "  ‚ûñ Removing java:zulu_$v (no longer exists)"
              sed -i "/| java:zulu_$v /d" README.md
              CHANGES_MADE="${CHANGES_MADE}Removed Java Zulu: $v\n"
            fi
          done

          # Remove deleted Java Dragonwell versions
          for v in $(grep -oP 'java:dragonwell_\K[0-9]+' README.md | sort -u); do
            if ! dir_exists "java/dragonwell/$v"; then
              echo "  ‚ûñ Removing java:dragonwell_$v (no longer exists)"
              sed -i "/| java:dragonwell_$v /d" README.md
              CHANGES_MADE="${CHANGES_MADE}Removed Java Dragonwell: $v\n"
            fi
          done

          # Remove deleted Java Liberica versions
          for v in $(grep -oP 'java:liberica_\K[0-9]+' README.md | sort -u); do
            if ! dir_exists "java/liberica/$v"; then
              echo "  ‚ûñ Removing java:liberica_$v (no longer exists)"
              sed -i "/| java:liberica_$v /d" README.md
              CHANGES_MADE="${CHANGES_MADE}Removed Java Liberica: $v\n"
            fi
          done

          # Remove deleted Java Shenandoah versions
          for v in $(grep -oP 'java:shenandoah_\K[0-9]+' README.md | sort -u); do
            if ! dir_exists "java/shenandoah/$v"; then
              echo "  ‚ûñ Removing java:shenandoah_$v (no longer exists)"
              sed -i "/| java:shenandoah_$v /d" README.md
              CHANGES_MADE="${CHANGES_MADE}Removed Java Shenandoah: $v\n"
            fi
          done

          # Remove deleted database versions
          for db in mariadb postgres mongodb redis; do
            for v in $(grep -oP "${db}:\K[0-9.]+(?= \|)" README.md | sort -u); do
              if ! dir_exists "database/$db/$v"; then
                echo "  ‚ûñ Removing $db:$v (no longer exists)"
                sed -i "/| $db:$v /d" README.md
                CHANGES_MADE="${CHANGES_MADE}Removed ${db^}: $v\n"
              fi
            done
          done

          # Remove deleted dev image versions
          for dev in nodejs python go elixir; do
            for v in $(grep -oP "${dev}:\K[0-9.]+(?= \|)" README.md | sort -u); do
              if ! dir_exists "dev/$dev/$v"; then
                echo "  ‚ûñ Removing $dev:$v (no longer exists)"
                sed -i "/| $dev:$v /d" README.md
                CHANGES_MADE="${CHANGES_MADE}Removed ${dev^}: $v\n"
              fi
            done
          done

          # Remove deleted game images
          for game in $(grep -oP 'games:\K[a-z0-9-]+(?= \|)' README.md | sort -u); do
            if ! dir_exists "games/$game"; then
              echo "  ‚ûñ Removing games:$game (no longer exists)"
              sed -i "/| games:$game /d" README.md
              CHANGES_MADE="${CHANGES_MADE}Removed Games: $game\n"
            fi
          done

          # ============================================
          # ADD NEW IMAGES
          # ============================================
          echo ""
          echo "‚ûï Checking for new images..."

          # ============================================
          # Check Java Base versions
          # ============================================
          echo "üì¶ Checking Java Base..."
          for v in $(get_versions "java/base"); do
            if ! check_image "java:$v "; then
              echo "  ‚ûï Adding java:$v"
              last_java=$(grep -n "| java:[0-9]" README.md | tail -1 | cut -d: -f1)
              if [ -n "$last_java" ]; then
                sed -i "${last_java}a\\| java:$v | \`ghcr.io/goover/java:$v\` | ‚úÖ | ‚úÖ |" README.md
                CHANGES_MADE="${CHANGES_MADE}Added Java Base: $v\n"
              fi
            fi
          done

          # ============================================
          # Check Java GraalVM versions
          # ============================================
          echo "üì¶ Checking Java GraalVM..."
          for v in $(get_versions "java/graalvm"); do
            if ! check_image "java:graalvm_$v "; then
              echo "  ‚ûï Adding java:graalvm_$v"
              last_graalvm=$(grep -n "| java:graalvm_" README.md | tail -1 | cut -d: -f1)
              if [ -n "$last_graalvm" ]; then
                sed -i "${last_graalvm}a\\| java:graalvm_$v | \`ghcr.io/goover/java:graalvm_$v\` | ‚úÖ | ‚úÖ |" README.md
                CHANGES_MADE="${CHANGES_MADE}Added Java GraalVM: $v\n"
              fi
            fi
          done

          # ============================================
          # Check Java Corretto versions
          # ============================================
          echo "üì¶ Checking Java Corretto..."
          for v in $(get_versions "java/corretto"); do
            if ! check_image "java:corretto_$v "; then
              echo "  ‚ûï Adding java:corretto_$v"
              last_corretto=$(grep -n "| java:corretto_" README.md | tail -1 | cut -d: -f1)
              if [ -n "$last_corretto" ]; then
                sed -i "${last_corretto}a\\| java:corretto_$v | \`ghcr.io/goover/java:corretto_$v\` | ‚úÖ | ‚úÖ |" README.md
                CHANGES_MADE="${CHANGES_MADE}Added Java Corretto: $v\n"
              fi
            fi
          done

          # ============================================
          # Check Java Zulu versions
          # ============================================
          echo "üì¶ Checking Java Zulu..."
          for v in $(get_versions "java/zulu"); do
            if ! check_image "java:zulu_$v "; then
              echo "  ‚ûï Adding java:zulu_$v"
              last_zulu=$(grep -n "| java:zulu_" README.md | tail -1 | cut -d: -f1)
              if [ -n "$last_zulu" ]; then
                sed -i "${last_zulu}a\\| java:zulu_$v | \`ghcr.io/goover/java:zulu_$v\` | ‚úÖ | ‚úÖ |" README.md
                CHANGES_MADE="${CHANGES_MADE}Added Java Zulu: $v\n"
              fi
            fi
          done

          # ============================================
          # Check Java Dragonwell versions
          # ============================================
          echo "üì¶ Checking Java Dragonwell..."
          for v in $(get_versions "java/dragonwell"); do
            if ! check_image "java:dragonwell_$v "; then
              echo "  ‚ûï Adding java:dragonwell_$v"
              last_dragonwell=$(grep -n "| java:dragonwell_" README.md | tail -1 | cut -d: -f1)
              if [ -n "$last_dragonwell" ]; then
                sed -i "${last_dragonwell}a\\| java:dragonwell_$v | \`ghcr.io/goover/java:dragonwell_$v\` | ‚úÖ | ‚úÖ |" README.md
                CHANGES_MADE="${CHANGES_MADE}Added Java Dragonwell: $v\n"
              fi
            fi
          done

          # ============================================
          # Check Java Liberica versions
          # ============================================
          echo "üì¶ Checking Java Liberica..."
          for v in $(get_versions "java/liberica"); do
            if ! check_image "java:liberica_$v "; then
              echo "  ‚ûï Adding java:liberica_$v"
              last_liberica=$(grep -n "| java:liberica_" README.md | tail -1 | cut -d: -f1)
              if [ -n "$last_liberica" ]; then
                sed -i "${last_liberica}a\\| java:liberica_$v | \`ghcr.io/goover/java:liberica_$v\` | ‚úÖ | ‚úÖ |" README.md
                CHANGES_MADE="${CHANGES_MADE}Added Java Liberica: $v\n"
              fi
            fi
          done

          # ============================================
          # Check Java Shenandoah versions
          # ============================================
          echo "üì¶ Checking Java Shenandoah..."
          for v in $(get_versions "java/shenandoah"); do
            if ! check_image "java:shenandoah_$v "; then
              echo "  ‚ûï Adding java:shenandoah_$v"
              last_shenandoah=$(grep -n "| java:shenandoah_" README.md | tail -1 | cut -d: -f1)
              if [ -n "$last_shenandoah" ]; then
                sed -i "${last_shenandoah}a\\| java:shenandoah_$v | \`ghcr.io/goover/java:shenandoah_$v\` | ‚úÖ | ‚úÖ |" README.md
                CHANGES_MADE="${CHANGES_MADE}Added Java Shenandoah: $v\n"
              fi
            fi
          done

          # ============================================
          # Check Database versions
          # ============================================
          for db in mariadb postgres mongodb redis; do
            echo "üì¶ Checking $db..."
            for v in $(get_versions "database/$db"); do
              if ! check_image "$db:$v "; then
                echo "  ‚ûï Adding $db:$v"
                last_db=$(grep -n "| $db:" README.md | tail -1 | cut -d: -f1)
                if [ -n "$last_db" ]; then
                  sed -i "${last_db}a\\| $db:$v | \`ghcr.io/goover/$db:$v\` | ‚úÖ | ‚úÖ |" README.md
                  CHANGES_MADE="${CHANGES_MADE}Added ${db^}: $v\n"
                fi
              fi
            done
          done

          # ============================================
          # Check Dev images (nodejs, python, go, etc.)
          # ============================================
          for dev in nodejs python go elixir; do
            echo "üì¶ Checking $dev..."
            for v in $(get_versions "dev/$dev"); do
              if ! check_image "$dev:$v "; then
                echo "  ‚ûï Adding $dev:$v"
                last_dev=$(grep -n "| $dev:" README.md | tail -1 | cut -d: -f1)
                if [ -n "$last_dev" ]; then
                  sed -i "${last_dev}a\\| $dev:$v | \`ghcr.io/goover/$dev:$v\` | ‚úÖ | ‚úÖ |" README.md
                  CHANGES_MADE="${CHANGES_MADE}Added ${dev^}: $v\n"
                fi
              fi
            done
          done

          # ============================================
          # Check DotNet versions
          # ============================================
          echo "üì¶ Checking dotnet..."
          for v in $(get_versions "dev/dotnet"); do
            if ! check_image "dotnet:$v "; then
              echo "  ‚ûï Adding dotnet:$v"
              last_dotnet=$(grep -n "| dotnet:" README.md | tail -1 | cut -d: -f1)
              if [ -n "$last_dotnet" ]; then
                sed -i "${last_dotnet}a\\| dotnet:$v | \`ghcr.io/goover/dotnet:$v\` | ‚úÖ | ‚ùå |" README.md
                CHANGES_MADE="${CHANGES_MADE}Added DotNet: $v\n"
              fi
            fi
          done

          # ============================================
          # Check Game images
          # ============================================
          echo "üì¶ Checking games..."
          for game in $(get_subdirs "games"); do
            if ! check_image "games:$game "; then
              echo "  ‚ûï Adding games:$game"
              last_game=$(grep -n "| games:" README.md | tail -1 | cut -d: -f1)
              if [ -n "$last_game" ]; then
                sed -i "${last_game}a\\| games:$game | \`ghcr.io/goover/games:$game\` | ‚úÖ | ‚ùå | ${game^} Server |" README.md
                CHANGES_MADE="${CHANGES_MADE}Added Games: $game\n"
              fi
            fi
          done

          # Output result
          if [ -n "$CHANGES_MADE" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo ""
            echo "‚úÖ Changes made:"
            echo -e "$CHANGES_MADE"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "‚úÖ README is already up to date!"
          fi

      - name: Create Pull Request
        if: steps.update.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "docs: add new Docker images to README"
          title: "üìù Update README - New Docker Images Detected"
          body: |
            ## ü§ñ Automated README Update

            This PR adds newly detected Docker images to the README.

            ### What changed:
            - New image entries have been added to the appropriate tables in README.md
            - All new entries follow the existing format

            ---

            *This PR was created automatically by the [Update README](.github/workflows/update-readme.yml) workflow.*
          branch: docs/readme-images-${{ github.run_number }}
          delete-branch: true
          add-paths: |
            README.md
          labels: |
            documentation
            automated
          assignees: gOOvER
          reviewers: gOOvER
